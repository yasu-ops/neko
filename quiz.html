<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>問題管理システム</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        button { margin: 5px; }
        #questionList { margin-top: 20px; }
        .question { margin-bottom: 10px; }
    </style>
</head>
<body>
    <div>
        <label for="fileInput">問題を選ぶ→</label>
        <input type="file" id="fileInput" accept=".csv">
        <button id="showWrongOnly">誤答のみ表示</button>
        <button id="showAll">全部表示</button>
        <button id="clearAllChecks">誤答チェックをすべて消す</button>
        <button id="saveFile">自分の解答結果を保存する</button>
    </div>
    <div id="questionList"></div>

    <script>
        let questions = [];

        document.getElementById('fileInput').addEventListener('change', (event) => {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                questions = parseCSV(content);
                displayQuestions();
            };
            reader.readAsText(file);
        });

        document.getElementById('saveFile').addEventListener('click', () => {
            const csv = questionsToCSV();
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "questions.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        });

        document.getElementById('showWrongOnly').addEventListener('click', () => {
            displayQuestions(true);
        });

        document.getElementById('showAll').addEventListener('click', () => {
            displayQuestions();
        });

        document.getElementById('clearAllChecks').addEventListener('click', () => {
            questions.forEach(q => q.isWrong = false);
            displayQuestions();
        });

        function parseCSV(content) {
            const lines = content.split('\n');
            return lines.map(line => {
                const [number, question, answer, isWrong, explanation] = line.split(',');
                return { number, question, answer, isWrong: isWrong === '1', explanation: explanation.trim() };
            });
        }

        function questionsToCSV() {
            return questions.map(q => 
                `${q.number},${q.question},${q.answer},${q.isWrong ? '1' : '0'},${q.explanation || ''}`
            ).join('\n');
        }

        function displayQuestions(wrongOnly = false) {
            const list = document.getElementById('questionList');
            list.innerHTML = '';
            questions.forEach(q => {
                if (!wrongOnly || q.isWrong) {
                    const div = document.createElement('div');
                    div.className = 'question';
                    div.innerHTML = `
                        ${q.number}. ${q.question}
                        <button onclick="toggleAnswer(${q.number}, this)">正解表示</button>
                        <input type="checkbox" ${q.isWrong ? 'checked' : ''} onchange="updateWrong(${q.number}, this.checked)">
                        <div id="answer${q.number}" style="display:none;">
                            正解: ${q.answer}
                            ${q.explanation ? `<br>解説: ${q.explanation}` : ''}
                        </div>
                    `;
                    list.appendChild(div);
                }
            });
        }

        function toggleAnswer(number, button) {
            const answerDiv = document.getElementById(`answer${number}`);
            if (answerDiv.style.display === 'none') {
                answerDiv.style.display = 'block';
                button.textContent = '正解を隠す';
            } else {
                answerDiv.style.display = 'none';
                button.textContent = '正解表示';
            }
        }

        function updateWrong(number, isWrong) {
            const question = questions.find(q => q.number == number);
            if (question) {
                question.isWrong = isWrong;
            }
        }
    </script>
</body>
</html>
